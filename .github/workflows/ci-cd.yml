name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Lint, build, and test Django (src/)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: bash
        working-directory: src
    env:
      DJANGO_SETTINGS_MODULE: website.settings
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      COVERAGE_FAIL_UNDER: "70"
      GIT_REF_NAME: ${{ github.ref_name }}
      GIT_SHA: ${{ github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            src/requirements.txt

      - name: Upgrade pip
        run: python -m pip install --upgrade pip
        working-directory: .

      - name: Install dependencies (root + src)
        run: |
          set -e
          if [ -f requirements.txt ]; then
            echo "Installing root requirements.txt";
            pip install -r requirements.txt;
          fi
          if [ -f src/requirements.txt ]; then
            echo "Installing src requirements.txt";
            pip install -r src/requirements.txt;
          fi
          python -c "import whitenoise" || pip install whitenoise==6.7.0
        working-directory: .

      - name: Install coverage tool
        run: pip install coverage==7.6.1
        working-directory: .

      - name: Show Python and pip env
        run: |
          python -V
          pip -V
          pip list --format=columns | sed -n '1,100p'
        working-directory: .

      - name: Environment summary
        run: |
          echo "## ðŸ§© Test environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: $GIT_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $GIT_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- Python: $(python -V | awk '{print $2}')" >> $GITHUB_STEP_SUMMARY
          echo "- Django: $(python -c 'import django; print(django.get_version())')" >> $GITHUB_STEP_SUMMARY
        working-directory: .

      - name: Django system check
        run: python manage.py check

      - name: Apply migrations
        run: python manage.py migrate --noinput

      - name: Collect static files (non-blocking)
        run: python manage.py collectstatic --noinput
        continue-on-error: true

      - name: Check for missing migrations (non-blocking)
        run: python manage.py makemigrations --check --dry-run
        continue-on-error: true

      # Lint step kept non-blocking to avoid breaking legacy branches
      - name: Optional lint (flake8) â€” non-blocking
        run: |
          pip install flake8 || true
          flake8 . || true
        working-directory: .

      - name: Run tests with coverage
        run: |
          set -o pipefail
          coverage run manage.py test --noinput -v 2 | tee test_output.txt

      - name: Coverage report (fail under threshold)
        run: |
          coverage report -m --fail-under=${COVERAGE_FAIL_UNDER}
          coverage xml -o coverage.xml

      - name: Publish test summary
        run: |
          echo "## âœ… Test results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          RAN_LINE=$(grep -E "Ran [0-9]+ test" -m1 test_output.txt || true)
          STATUS_LINE=$(grep -E "^(OK|FAILED)" -m1 test_output.txt || true)
          if [ -n "$RAN_LINE" ]; then echo "- $RAN_LINE" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$STATUS_LINE" ]; then echo "- Status: $STATUS_LINE" >> $GITHUB_STEP_SUMMARY; fi

      - name: Publish coverage summary
        run: |
          echo "## ðŸ“Š Coverage report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(coverage report -m | tee coverage.txt | tail -n1 | awk '{print $NF}')
          echo "- Total coverage: $TOTAL (threshold ${COVERAGE_FAIL_UNDER}%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Show full table</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat coverage.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage xml artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: src/coverage.xml
          retention-days: 7

      - name: Generate coverage HTML report (artifact)
        run: coverage html

      - name: Upload coverage HTML artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: src/htmlcov
          retention-days: 7

      - name: Upload test log artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: src/test_output.txt
          retention-days: 7

  deploy:
    name: Build and push Docker image (CD)
    # Run on push to target branches OR PRs whose head_ref matches target branches OR for fix/cicd branch while validating
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/backend' || github.ref == 'refs/heads/fix/cicd' || github.ref == 'refs/heads/final')) ||
      (github.event_name == 'pull_request' && (github.head_ref == 'main' || github.head_ref == 'backend' || github.head_ref == 'fix/cicd' || github.head_ref == 'final'))
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/woodmansworld
          tags: |
            type=sha
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DJANGO_DEBUG=False
      - name: Deployment summary
        run: |
          echo "## ðŸšš Image build & push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tags:" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
  release:
    name: Deploy to remote host (CD runtime)
    if: >
      needs.deploy.result == 'success' && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/backend' || github.ref == 'refs/heads/fix/cicd' || github.ref == 'refs/heads/final')) ||
        (github.event_name == 'pull_request' && (github.head_ref == 'main' || github.head_ref == 'backend' || github.head_ref == 'fix/cicd' || github.head_ref == 'final'))
      )
    needs: deploy
    runs-on: ubuntu-latest
    env:
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
    steps:
      - name: Check secrets
        id: secrets_check
        run: |
          if [ -n "$SSH_KEY" ] && [ -n "$SSH_HOST" ] && [ -n "$SSH_USER" ]; then
            echo "deploy_ok=true" >> $GITHUB_OUTPUT
          else
            echo "deploy_ok=false" >> $GITHUB_OUTPUT
            echo "Missing SSH secrets; release step will be skipped."
          fi
      - name: Write SSH key
        if: steps.secrets_check.outputs.deploy_ok == 'true'
        run: |
          echo "$SSH_KEY" > id_rsa
          chmod 600 id_rsa
      - name: Remote deploy (pull and run container)
        if: steps.secrets_check.outputs.deploy_ok == 'true'
        env:
          IMAGE_SHA: ghcr.io/${{ github.repository_owner }}/woodmansworld:${{ github.sha }}
          IMAGE_LATEST: ghcr.io/${{ github.repository_owner }}/woodmansworld:latest
        run: |
          REMOTE_CMD="docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} \
            && (docker pull $IMAGE_SHA || docker pull $IMAGE_LATEST) \
            && (docker stop woodman || true) \
            && (docker rm woodman || true) \
            && (docker run -d --name woodman -p 8000:8000 $IMAGE_SHA || docker run -d --name woodman -p 8000:8000 $IMAGE_LATEST)"
          ssh -o StrictHostKeyChecking=no -i id_rsa "$SSH_USER@$SSH_HOST" "$REMOTE_CMD"
      - name: Post-deploy health check
        if: steps.secrets_check.outputs.deploy_ok == 'true'
        run: |
          curl -f http://$SSH_HOST:8000/ || (echo "Remote health check failed" && exit 1)
      - name: Release summary (deployed)
        if: steps.secrets_check.outputs.deploy_ok == 'true'
        run: |
          echo "## ðŸš€ Remote deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Host: $SSH_HOST" >> $GITHUB_STEP_SUMMARY
          echo "- Service: woodman (port 8000)" >> $GITHUB_STEP_SUMMARY
          echo "- Health: OK" >> $GITHUB_STEP_SUMMARY
      - name: Release skipped (no secrets)
        if: steps.secrets_check.outputs.deploy_ok != 'true'
        run: |
          echo "Release stage skipped due to missing SSH_* secrets."
          echo "## ðŸš« Remote deploy skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Missing SSH_KEY, SSH_HOST, or SSH_USER" >> $GITHUB_STEP_SUMMARY
