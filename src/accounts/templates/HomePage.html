{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woodman's World - Handcrafted Marketplace</title>

    <!-- Theme -->
    <script>
        if (localStorage.theme === 'dark' ||
            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.add('light');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body id="app">
    <!-- Hidden CSRF Loader -->
    <form style="display:none;">{% csrf_token %}</form>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white dark:bg-neutral-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">

                <!-- Logo -->
                <a href="{% url 'home' %}" class="text-2xl font-bold">
                    Woodman's World
                </a>

                <div class="flex items-center space-x-4">

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" class="icon-btn p-2">
                        <svg id="theme-toggle-icon" class="w-6 h-6"></svg>
                    </button>

                    <!-- Account -->
                    {% if user.is_authenticated %}
                    <div class="relative">
                        <button onclick="toggleUserMenu()" 
                                class="flex items-center hover:text-amber-600 icon-btn">
                            <span class="text-sm font-medium">Hi, {{ user.first_name }}!</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>

                        <div id="user-menu"
                             class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-neutral-700 shadow-lg rounded-lg">
                            <a href="{% url 'buyer_profile' %}"
                               class="block px-4 py-2 hover:bg-stone-100 dark:hover:bg-neutral-600">
                                Profile
                            </a>

                            <a href="{% url 'logout_user' %}"
                               class="block px-4 py-2 bg-red-600 text-white text-center hover:bg-red-700 rounded-b-lg">
                                Logout
                            </a>
                        </div>
                    </div>

                    {% else %}

                    <a href="{% url 'login_register' %}" class="flex items-center icon-btn">
                        Account / Login
                    </a>

                    {% endif %}

                    <!-- Cart -->
                    <a href="{% url 'shopping_cart' %}" class="relative p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>

                        <span id="cart-count"
                              class="absolute top-0 right-0 px-2 py-1 text-xs font-bold text-white bg-red-600 rounded-full">
                            {% if user.is_authenticated %}
                                {{ request.user.cartitem_set.count }}
                            {% else %}
                                0
                            {% endif %}
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto py-8">
        <h2 class="text-3xl font-extrabold mb-6">Featured Artisanal Items</h2>

        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </main>

    <!-- JS -->
    <script>
        /* FIX #1 — Real Django Product IDs */
        const products = [
            { id: 1, name: 'Hand-Carved Walnut Bowl', artisan: 'Woodman & Co.', shortDescription: 'A timeless centerpiece.', price: 59.99, imageColor: '7c2d12', imageText: 'Wood+Bowl' },
            { id: 2, name: 'Sterling Silver Leaf Earrings', artisan: 'Jewels by Jane', shortDescription: 'Delicate silver leaf.', price: 45.00, imageColor: '9ca3af', imageText: 'Earrings' },
            { id: 3, name: 'Earthenware Coffee Mug Set', artisan: 'Clara Ceramics', shortDescription: 'Hand-thrown mugs.', price: 35.50, imageColor: 'f97316', imageText: 'Mug+Set' },
            { id: 4, name: 'Bohemian Wwoven Throw', artisan: 'Textile Threads', shortDescription: 'Cozy cotton.', price: 89.99, imageColor: 'a3a3a3', imageText: 'Throw' },
            { id: 5, name: 'Abstract Geode Art', artisan: 'Stone & Sparkle', shortDescription: 'Unique resin art.', price: 120.00, imageColor: '4c4c4c', imageText: 'Resin+Art' },
            { id: 6, name: 'Oak Cutting Board', artisan: 'Woodman & Co.', shortDescription: 'End-grain butcher block.', price: 75.00, imageColor: '451a03', imageText: 'Cutting+Board' },
            { id: 7, name: 'Turquoise Pendant Necklace', artisan: 'Jewels by Jane', shortDescription: 'Vibrant stone pendant.', price: 65.00, imageColor: '4b5563', imageText: 'Necklace' },
            { id: 8, name: 'Speckled Serving Platter', artisan: 'Clara Ceramics', shortDescription: 'Ideal for appetizers.', price: 49.00, imageColor: '1f2937', imageText: 'Platter' },
        ];

        function renderProducts() {
            const grid = document.getElementById("product-grid");

            grid.innerHTML = products.map(p => {
                const img = `https://placehold.co/400x300/${p.imageColor}/ffffff?text=${p.imageText}`;
                return `
                <div class="bg-white dark:bg-neutral-800 rounded-xl shadow">
                    <img src="${img}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-lg">${p.name}</h3>
                        <p class="text-amber-600">${p.artisan}</p>
                        <p class="text-xs">${p.shortDescription}</p>
                        <div class="flex justify-between mt-3">
                            <span class="font-bold text-xl">$${p.price}</span>

                            <button onclick="addToCart(${p.id})"
                                class="px-3 py-1 bg-amber-600 text-white rounded-full hover:bg-amber-700">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        /* FIX #2 — AJAX Add to Cart */
        function addToCart(productId) {
            const csrf = getCookie("csrftoken");

            fetch("{% url 'add_to_cart' %}", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-CSRFToken": csrf,
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `product_id=${productId}&quantity=1`
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("cart-count").textContent = data.cart_count;
                }
            });
        }

        /* CSRF Helper */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
            }
            return cookieValue;
        }

        function toggleUserMenu() {
            document.getElementById("user-menu").classList.toggle("hidden");
        }

        window.onload = renderProducts;
    </script>
</body>
</html>
